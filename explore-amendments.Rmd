---
title: Amendments to GOV.UK statistics publications
description: |
  Exploratory data analysis to inform Reproducible Analytical Pipelines
author: Duncan Garmonsway
date: January 15, 2019
output:
  html_document:
    self_contained: true
    code_folding: hide
---

## Introduction

The [Reproducible Analytical Pipeline
(RAP)](https://dataingovernment.blog.gov.uk/2017/03/27/reproducible-analytical-pipeline/)
is an alternative production methodology for automating the bulk of steps
involved in creating a statistical report.

One motivation to use RAP methods is to avoid making mistakes, by removing as
much opportunity for human error as possible.  For example, the following
note describes a trivial amendment that could have been avoided by programming a
computer to update the date of the quarterly publication.

> The date for the publication ... was incorrectly stated as 14 February 2019,
> this has now been corrected to 21 February 2019 which is in line with the
> release calendar and established practice to publish on the third Thursday of
> the month.

* How common are amendments?
* Are they becoming more or less common?
* Why are amendments made?

```{r setup, include = FALSE}
library(tidyverse)
library(lubridate)
library(ebbr)
library(DT)
library(here)

knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      fig.width = 9.5)

reports <- readRDS(here("reports.Rds"))

theme_set(theme_bw())
```

```{r change-history}
# Extract the change history of each report

empty_changes <- tibble(public_timestamp = character(),
                        note = character())

chuck_changes <-
  function(.x) {
    out <- purrr::chuck(.x, "details", "change_history") # purrr::chuck() not on CRAN
    if (is.null(out)) {
      stop("null!") # change_history can be present yet NULL
    }
    out
  }
possibly_pluck_changes <- possibly(chuck_changes, otherwise = empty_changes)

chuck_organisation <-
  function(.x) {
    out <- purrr::chuck(.x, # purrr::chuck() not on CRAN
                        "links",
                        "primary_publishing_organisation",
                        "title")
    if (is.null(out)) {
      stop("null!") # element can be present yet NULL
    }
    out
  }
possibly_pluck_organisation <-
  possibly(chuck_organisation, otherwise = NA_character_)

changes <-
  reports %>%
  mutate(organisation = map_chr(reports, possibly_pluck_organisation),
         changes = map(reports, possibly_pluck_changes)) %>%
  select(-reports) %>%
  unnest() %>%
  mutate(public_timestamp = parse_datetime(public_timestamp),
         month = floor_date(public_timestamp, "month"),
         year = floor_date(public_timestamp, "year"),
         is_first_publication = note == "First published.",
         is_amendment = str_detect(note,
                                   regex("(mistake)|(error)|(correct)|(wrong)|(amend)",
                                         ignore_case = TRUE)),
         is_amendment = is_amendment & !str_detect(note, "Updated to reflect amendments made to existing licences since previous publication"))

no_changes <- anti_join(reports, changes, by = "base_path")
```

## How common are changes (not just amendments)?

Many first publications were backdated.  The date of the first change is a
reasonable estimate for the date that GOV.UK first published statistics

```{r first-change-date}
first_change_date <-
  changes %>%
  dplyr::filter(!is_first_publication) %>%
  pull(public_timestamp) %>%
  min()
```

### Changes per month

```{r changes-per-month}
changes %>%
  dplyr::filter(public_timestamp >= first_change_date,
                month < max(month)) %>% # drop the latest (incomplete) month
  count(month, is_first_publication) %>%
  ggplot(aes(month, n, colour = is_first_publication)) +
  geom_line() +
  scale_colour_discrete(name = "First publication") +
  xlab("") +
  ylab("Number of new publications or changes") +
  ggtitle("Number of new publications and changes per month")
```

### Changes per year

```{r changes-per-year}
changes %>%
  dplyr::filter(public_timestamp >= first_change_date,
                year < max(year)) %>% # drop the latest (incomplete) year
  count(year, is_first_publication) %>%
  ggplot(aes(year, n, colour = is_first_publication)) +
  geom_line() +
  scale_colour_discrete(name = "First publication") +
  xlab("") +
  ylab("Number of new publications or changes") +
  ggtitle("Number of new publications and changes per year")
```

## How common are amendments?

Define 'amendment' as a change where the following regex matches (not case
sensitive).

`mistake)|(error)|(correct)|(wrong)|(amend)`

```{r amendments}
amendments <- dplyr::filter(changes, is_amendment)
```

### Amendments per month

```{r amendments-per-month}
amendments %>%
  dplyr::filter(public_timestamp >= first_change_date,
                month < max(month)) %>% # drop the latest (incomplete) month
  count(month) %>%
  ggplot(aes(month, n)) +
  geom_line() +
  xlab("") +
  ylab("Number of amendments") +
  ggtitle("Number of amendments per month")
```

### Amendments per year

```{r amendments-per-year}
amendments %>%
  dplyr::filter(public_timestamp >= first_change_date,
                year < max(year)) %>% # drop the latest (incomplete) year
  count(year) %>%
  ggplot(aes(year, n)) +
  geom_line() +
  xlab("") +
  ylab("Number of amendments") +
  ggtitle("Number of amendments per year")
```

### Amendments as percentage of all changes per month

```{r amendments-percent-per-month}
changes %>%
  dplyr::filter(public_timestamp >= first_change_date,
                month < max(month)) %>% # drop the latest (incomplete) month
  count(month, is_amendment) %>%
  spread(is_amendment, n, fill = 0L) %>%
  mutate(amendment_prop = `TRUE` / (`TRUE` + `FALSE`)) %>%
  ggplot(aes(month, amendment_prop)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  xlab("") +
  ylab("") +
  ggtitle("Amendments as a percentage of all changes (monthly)")
```

#' ### Amendments as percentage of all changes per year

```{r amendments-percent-per-year}
changes %>%
  dplyr::filter(public_timestamp >= first_change_date,
                year < max(year)) %>% # drop the latest (incomplete) year
  count(year, is_amendment) %>%
  spread(is_amendment, n, fill = 0L) %>%
  mutate(amendment_prop = `TRUE` / (`TRUE` + `FALSE`)) %>%
  ggplot(aes(year, amendment_prop)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  xlab("") +
  ylab("") +
  ggtitle("Amendments as a percentage of all changes (annual)")
```

### Organisations with the highest and lowest rate of amendments

Using fitted Empirical Bayes model to reduce noise of orgs with few
publications.  The prior is parameterised by fitting a beta-binomial to all the
data by maximum likelihood estimation; see
[`?ebbr::ebb_fit_prior`](https://github.com/dgrtwo/ebbr/blob/master/R/ebb_fit_prior.R)
for details.

```{r bayes-rate-estimate, fig.height = 8}
bayes_rates <-
  changes %>%
  dplyr::filter(public_timestamp >= first_change_date,
                year < max(year)) %>% # drop the latest (incomplete) year
  count(year, organisation, is_amendment) %>%
  spread(is_amendment, n, fill = 0L) %>%
  mutate(total = `TRUE` + `FALSE`,
         amendments = `TRUE`) %>%
  select(-`TRUE`, -`FALSE`) %>%
  add_ebb_estimate(amendments, total)
```

```{r amendment-rate-low, fig.height = 8}
bayes_rates %>%
  # keep orgs with less than this rate of amendments
  dplyr::filter(.high <= .01) %>%
  ggplot(aes(organisation)) +
  geom_point(aes(y = .fitted)) +
  geom_point(aes(y = amendments / total), colour = "red") +
  geom_errorbar(aes(ymin = .low, ymax = .high)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, NA),
                     breaks = seq(0, 1, by = .001)) +
  ggtitle("Organisations with an annual amendment rate lower than 1%",
          subtitle = "Red is the true percentage, black is the Empirical Bayes estimate with 95% credible interval") +
  facet_wrap(~ year, ncol = 1, scales = "free_y") +
  coord_flip() +
  xlab("") +
  ylab("Percentage of all changes that were amendments")
```

```{r amendment-rate-high, fig.height = 5}
bayes_rates %>%
  # keep orgs with at least this rate of amendments
  dplyr::filter(.low >= .05) %>%
  ggplot(aes(organisation)) +
  geom_point(aes(y = .fitted)) +
  geom_point(aes(y = amendments / total), colour = "red") +
  geom_errorbar(aes(ymin = .low, ymax = .high)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, NA),
                     breaks = seq(0, 1, by = .1)) +
  ggtitle("Organisations with an annual amendment rate higher than 5%",
          subtitle = "Red is the true percentage, black is the Empirical Bayes estimate with 95% credible interval") +
  facet_wrap(~ year, ncol = 1, scales = "free_y") +
  coord_flip() +
  xlab("") +
  ylab("Percentage of all changes that were amendments")
```

## Why are amendments made

```{r table-of-notes, layout = "l-page"}
changes %>%
  dplyr::filter(is_amendment) %>%
  arrange(desc(public_timestamp)) %>%
  select(publication = base_path,
         organisation,
         timestamp = public_timestamp,
         note) %>%
  datatable()
```

## Session info

```{r}
devtools::session_info()
```

